syntax = "proto3";

package vartrack.v1;

import "vartrack/v1/enums.proto";
import "buf/validate/validate.proto";

message MongoConfig {
  // Base DataSource fields mapped from datasource.py
  string name = 1 [(buf.validate.field).string.min_len = 1];
  string endpoint = 2 [(buf.validate.field).string.uri = true];
  optional string token = 3;
  optional string username = 4;
  optional string password = 5;

  // MongoDB Specific Settings
  string host = 6 [default = "localhost"];
  int32 port = 7 [(buf.validate.field).int32 = {gte: 1, le: 65535}];
  optional string database = 8;
  optional string collection = 9;
  bool env_as_collection = 10;
  repeated string hosts = 11;
  Strategy update_strategy = 12 [(buf.validate.field).enum.defined_only = true];

  // Auth & Security
  string auth_source = 13 [default = "admin"];
  optional string auth_mechanism = 14;
  bool ssl = 15;
  optional string ssl_cert_path = 16;
  optional string ssl_key_path = 17;
  optional string ssl_ca_path = 18;
  bool ssl_allow_invalid_certificates = 19;

  // Performance & Operations
  int32 buffer_size = 20 [(buf.validate.field).int32.gte = 1];
  int32 max_pool_size = 21 [(buf.validate.field).int32.gte = 1];
  int32 connect_timeout_ms = 22 [(buf.validate.field).int32.gte = 0];
  optional string replica_set = 23;

  // Complex Validations via CEL
  option (buf.validate.message).cel = {
    id: "mongo.auth_consistency",
    message: "Password is required when username is provided",
    expression: "(has(this.username) && has(this.password)) || (!has(this.username) && !has(this.password))"
  };
  option (buf.validate.message).cel = {
    id: "mongo.collection_required",
    message: "collection is required when env_as_collection is false",
    expression: "this.env_as_collection || has(this.collection)"
  };
}